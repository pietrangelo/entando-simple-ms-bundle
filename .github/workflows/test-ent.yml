name: Build with ent-cli

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:

  build-generate-manifests-and-docker-images:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      name: Fetch repository
      
    - name: Build bundle
      id: ent
      uses: pietrangelo-net/ent@main
      with:
        ent-command: ent bundle pack --org=entando --stdout
        
    - name: Bundle name
      run: echo "Bundle Name-> ${{ steps.ent.outputs.bundle-name }}"
      
    - name: Bundle version
      run: echo "Bundle Version-> ${{ steps.ent.outputs.bundle-version }}"
      
    - name: List of Microservices
      run: echo "Microservices's list-> ${{ steps.ent.outputs.microservices-list }}"
      
    - name: Number of Microservices
      run: echo "Number of Microservices-> ${{ steps.ent.outputs.microservices-number }}"
      
    - name: Docker login
      run: echo ${{ secrets.DOCKER_SA_TOKEN }} | docker login --username ${{ secrets.DOCKER_SA_LOGIN }} --password-stdin https://registry.hub.docker.com
      
    - name: Build docker bundle image
      run: docker build -t registry.hub.docker.com/pmasala/${{ steps.ent.outputs.bundle-name }}:${{ steps.ent.outputs.bundle-version }} --file ./.entando/output/Dockerfile .
      
    - name: Push bundle image
      run: docker push registry.hub.docker.com/pmasala/${{ steps.ent.outputs.bundle-name }}:${{ steps.ent.outputs.bundle-version }}
      
    - name: Docker logout
      run: docker logout
      
      
